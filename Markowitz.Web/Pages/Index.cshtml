@page
@model Markowitz.Web.Pages.IndexModel
@{
    ViewData["Title"] = "Markowitz Optimizer";
}

<h1>Markowitz Optimizer (MVP)</h1>

<form method="post" enctype="multipart/form-data">
  <div>
    <label>CSV files (timestamp, open, high, low, close):</label>
    <input type="file" name="Files" multiple />
  </div>
  <div>
    <label>Lookback (days):</label>
    <input type="number" asp-for="LookbackDays" />
  </div>
  <div>
    <label>Start:</label>
    <input type="date" asp-for="Start" />
    <label>End:</label>
    <input type="date" asp-for="End" />
  </div>
  <div>
    <label>Target Return (annual, e.g. 0.10):</label>
    <input type="number" step="0.0001" asp-for="TargetReturnAnnual" />
    <small>Leave empty for GMV.</small>
  </div>
  <button type="submit">Optimize</button>
</form>

@if (Model.Result != null)
{
  <hr />
  <h2>Result</h2>
  <p>
    <b>Expected Return (annual):</b> @Model.Result.ExpectedReturnAnnual.ToString("P2")<br />
    <b>Volatility (annual σ):</b> @Model.Result.VolatilityAnnual.ToString("P2")<br />
    <b>Observations:</b> @Model.Result.Observations
  </p>

  <div style="max-width:600px;">
    <canvas id="weightsPie"></canvas>
  </div>

  <table>
    <thead><tr><th>Ticker</th><th>Weight</th></tr></thead>
    <tbody>
    @foreach (var kv in Model.Result.Weights)
    {
      <tr><td>@kv.Key</td><td>@kv.Value.ToString("P2")</td></tr>
    }
    </tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const data = {
      labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Result.Weights.Keys)),
      datasets: [{
        data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Result.Weights.Values))
      }]
    };
    new Chart(document.getElementById('weightsPie'), { type: 'pie', data: data });
  </script>
}
